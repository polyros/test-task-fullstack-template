name: AI Code Review

on:
  workflow_run:
    workflows: ["Tests"]
    types: [completed]

jobs:
  ai-review:
    # Запускаем после завершения тестов (независимо от результата)
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR diff
        run: |
          git diff origin/main...HEAD > diff.txt
          echo "Diff size: $(wc -l < diff.txt) lines"

      - name: Get REVIEW.md
        run: |
          if [ -f REVIEW.md ]; then
            cat REVIEW.md > review.txt
          else
            echo "(REVIEW.md не найден)" > review.txt
          fi

      - name: Claude AI Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          python scripts/claude_review.py \
            --diff diff.txt \
            --review review.txt \
            --output result.json \
            --task-type fullstack

      - name: Upload review result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-result
          path: result.json

      - name: Generate PR comment
        if: always()
        run: |
          if [ -f result.json ]; then
            python3 << 'PYEOF'
          import json
          import textwrap

          with open('result.json', 'r') as f:
              result = json.load(f)

          score = result.get('score', 0)
          emoji = '✅' if score >= 60 else ('⚠️' if score >= 40 else '❌')
          breakdown = result.get('breakdown', {})

          problems_found = '\n'.join([f"- `{p}`" for p in result.get('problems_found', [])]) or '_Не указаны_'
          problems_fixed = '\n'.join([f"- `{p}`" for p in result.get('problems_fixed', [])]) or '_Не указаны_'
          strengths = '\n'.join([f"- {s}" for s in result.get('strengths', [])]) or '_Не указаны_'
          improvements = '\n'.join([f"- {s}" for s in result.get('improvements', [])]) or '_Не указаны_'

          comment = f"""## {emoji} AI Code Review

**Оценка: {score}/100**

{result.get('summary', '')}

### Breakdown
| Критерий | Баллы |
|----------|-------|
| Найденные проблемы | {breakdown.get('problems', 0)}/30 |
| Качество исправлений | {breakdown.get('fixes', 0)}/35 |
| Качество review | {breakdown.get('review', 0)}/15 |
| Качество тестов | {breakdown.get('tests', 0)}/20 |

### Найденные проблемы
{problems_found}

### Исправленные проблемы
{problems_fixed}

### Сильные стороны
{strengths}

### Рекомендации по улучшению
{improvements}

---
*Рекомендация: **{result.get('recommendation', 'N/A')}***
"""

          with open('pr_comment.md', 'w') as f:
              f.write(comment)
          PYEOF
          fi

      - name: Post PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let body;
            try {
              body = fs.readFileSync('pr_comment.md', 'utf8');
            } catch (e) {
              console.log('Не удалось прочитать pr_comment.md:', e);
              return;
            }

            const prs = context.payload.workflow_run.pull_requests;
            if (prs && prs.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                body: body
              });
            } else {
              console.log('PR не найден для этого workflow run');
            }

      - name: Send AI Review to HR-Agent
        if: always()
        run: |
          if [ -f result.json ]; then
            # Добавляем метаданные
            SCORE=$(jq -r '.score // 0' result.json)
            RECOMMENDATION=$(jq -r '.recommendation // "review"' result.json)

            # Получаем номер PR из workflow_run
            PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"

            # Отправляем на публичный endpoint
            curl -X POST "https://hr.predictmarket.ru/api/v1/test-task/ai-report" \
              -H "Content-Type: application/json" \
              -d '{
                "repo": "${{ github.repository }}",
                "pr_number": '"${PR_NUMBER:-0}"',
                "run_id": ${{ github.run_id }},
                "score": '"$SCORE"',
                "recommendation": "'"$RECOMMENDATION"'"
              }' \
              --fail-with-body || echo "Warning: Failed to send AI review to HR-Agent"
          fi
